<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Flocking with Go | sausheong&#39;s space</title>

<meta property='og:title' content='Flocking with Go - sausheong&#39;s space'>
<meta property='og:description' content='I have been writing flocking simulations for a long time. I played around with it with Java but the earliest one I still have record of was with JRuby and Swing called Utopia. I subsequently wrote one using Shoes and that was the one in my Exploring Everyday Things witn R and Ruby book. Some time after (I was unhappy with Shoes in general), I re-wrote it again using Gosu, a 2D game development library for Ruby and C&#43;&#43;.'>
<meta property='og:url' content='https://sausheong.github.io/posts/flocking-with-go/'>
<meta property='og:site_name' content='sausheong&#39;s space'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/ee191858f0d96ad93098694537f71998?s=256'><meta property='article:author' content='https://facebook.com/sausheong'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2018-01-15T01:04:07&#43;08:00'/><meta property='article:modified_time' content='2018-01-15T01:04:07&#43;08:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@sausheong'><meta name='twitter:creator' content='@sausheong'>
<link rel="stylesheet" href="https://sausheong.github.io/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://sausheong.github.io"><h1 class="title is-4">sausheong&#39;s space</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:sausheong@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://facebook.com/sausheong' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/sausheong' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://instagram.com/sausheong' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/sausheong' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/sausheong' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">January 15, 2018</h2>
    <h1 class="title">Flocking with Go</h1>
      
    <div class="content">
      

<p>I have been writing flocking simulations for a long time. I played around with it with Java but the earliest one I still have record of was with JRuby and Swing called <a href="https://youtu.be/x44s8TTWm5E" target="_blank">Utopia</a>. I subsequently wrote one using <a href="http://shoesrb.com" target="_blank">Shoes</a> and that was the one in my <a href="http://shop.oreilly.com/product/0636920022626.do" target="_blank"><em>Exploring Everyday Things witn R and Ruby</em></a> book. Some time after (I was unhappy with Shoes in general), I re-wrote it again using <a href="https://github.com/gosu/gosu" target="_blank">Gosu</a>, a 2D game development library for Ruby and C++. This version can be found <a href="https://github.com/sausheong/utopia" target="_blank">here</a>.</p>

<p><a href="https://en.wikipedia.org/wiki/Flocking_(behavior)" target="_blank">Flocking</a> simulations are basically a software program that simulates the flocking behavior of birds. This flocking behavior is very somewhat similar to the swarming behavior of insects or the shoaling behavior of fish. It&rsquo;s considered an emergent behavior &ndash; a behavior that arises from individuals following simple rules and doesn&rsquo;t involve any central coordination. Such behavior, especially seen in murmurations of starlings or swarms of barracuda can be a breath-taking phenomenon.</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/flocking.jpg" alt="murmuration of starlings" /></p>

<h2 id="boids">Boids</h2>

<p>Flocking was first simulated in software by Craig Reynolds, a programmer who developed a software program called <a href="http://www.red3d.com/cwr/boids/" target="_blank"><em>boids</em></a> and published a paper on the topic in 1987 in the proceedings of the ACM SIGGRAPH conference. Since then, there has been a number of advancements in simulating flocking but nonetheless the basic idea still remains pretty simple.</p>

<p>Boids itself used three basic rules to describe how an individual boid moves around:</p>

<ul>
<li><em>Separation</em> &ndash; avoid crowding other flockmates that are close by</li>
<li><em>Alignment</em> &ndash; move towards the average direction of nearby flockmates</li>
<li><em>Cohesion</em> &ndash; move towards the average position of nearby flockmates</li>
</ul>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/Rule_separation.gif" alt="separation" />
<img src="https://github.com/sausheong/goids/raw/master/imgs/Rule_alignment.gif" alt="alignment" />
<img src="https://github.com/sausheong/goids/raw/master/imgs/Rule_cohesion.gif" alt="cohesion" /></p>

<p>These rules have been expanded and in some cases, more rules have been added but the fundamental idea is that a localised reaction by an individual following a few simple rules can result in complex, unexpected behavior.</p>

<h2 id="doing-it-in-go">Doing it in Go</h2>

<p>While I have been programming in Go seriously for a few years (it&rsquo;s my primary programming language now), I haven&rsquo;t been able to figure out a good way to write a flocking simulation with Go all this time. The biggest problem is that Go is mostly a backend programming language and doesn&rsquo;t really have a GUI toolkit. While there were a few attempts, including bindings to GTK and QT, none of them fit what I wanted. If you&rsquo;re looking for one for a desktop application, you are probably better off using <a href="https://github.com/electron/electron" target="_blank">Electron</a> and building a web application in Go to back that up.</p>

<p>That is, until I was fiddling around with genetic algorithms in my post <a href="https://sausheong.github.io/posts/a-gentle-introduction-to-genetic-algorithms/" target="_blank"><em>A gentle introduction to genetic algorithms</em></a>. In that post I was trying to display an image to the terminal, in my case, the excellent <a href="https://www.iterm2.com/" target="_blank">iTerm2</a>. There&rsquo;s where I stumbled on this hack on iTerm2 that allows me to display images on the screen.</p>

<p>Naturally if I can display one image, I can always display multiple images. And if I can display multiple images, I can also display them overlaying each other, one after another. And if I can display them fast enough &hellip;</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/flip.gif" alt="flipbook" /></p>

<h2 id="goids">Goids</h2>

<p>I call them <em>goids</em>, of course. A <code>Goid</code> is a simple struct with information on its position, velocity and color.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Goid</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">X</span>     <span class="kt">int</span> <span class="c1">// position
</span><span class="c1"></span>	<span class="nx">Y</span>     <span class="kt">int</span>
	<span class="nx">Vx</span>    <span class="kt">int</span> <span class="c1">// velocity
</span><span class="c1"></span>	<span class="nx">Vy</span>    <span class="kt">int</span>
	<span class="nx">R</span>     <span class="kt">int</span> <span class="c1">// radius
</span><span class="c1"></span>	<span class="nx">Color</span> <span class="nx">color</span><span class="p">.</span><span class="nx">Color</span>
<span class="p">}</span></code></pre></div>
<p>Position and color is pretty easy to understand. Velocity here is not simply the speed the goid is moving but also direction it is moving. In this case, <code>Vx</code> and <code>Vy</code> is how far away the goid is going to be away the next loop, and also directionally where it&rsquo;s going to be. Mathematically speaking, while <code>X</code> and <code>Y</code> is the <em>scalar</em> position (it tells you how far away from origin on a 2D plane), <code>Vx</code> and <code>Vy</code> is a <a href="http://mathinsight.org/vector_introduction" target="_blank"><em>vector</em></a>.</p>

<p>Creating goids is relatively simple. Each goid must be within the window and its starting velocity is smaller than its size.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">createRandomGoid</span><span class="p">()</span> <span class="p">(</span><span class="nx">g</span> <span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">g</span> <span class="p">=</span> <span class="nx">Goid</span><span class="p">{</span>
		<span class="nx">X</span><span class="p">:</span>     <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">windowWidth</span><span class="p">),</span>
		<span class="nx">Y</span><span class="p">:</span>     <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">windowHeight</span><span class="p">),</span>
		<span class="nx">Vx</span><span class="p">:</span>    <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">goidSize</span><span class="p">),</span>
		<span class="nx">Vy</span><span class="p">:</span>    <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">goidSize</span><span class="p">),</span>
		<span class="nx">R</span><span class="p">:</span>     <span class="nx">goidSize</span><span class="p">,</span>
		<span class="nx">Color</span><span class="p">:</span> <span class="nx">goidColor</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></div>
<p>The bulk of the work is in the <code>move</code> function.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// move the goids with the 3 classic boid rules
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">move</span><span class="p">(</span><span class="nx">goids</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">goid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">goids</span> <span class="p">{</span>
		<span class="nx">neighbours</span> <span class="o">:=</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">nearestNeighbours</span><span class="p">(</span><span class="nx">goids</span><span class="p">)</span>
		<span class="nx">separate</span><span class="p">(</span><span class="nx">goid</span><span class="p">,</span> <span class="nx">neighbours</span><span class="p">)</span>		
		<span class="nx">align</span><span class="p">(</span><span class="nx">goid</span><span class="p">,</span> <span class="nx">neighbours</span><span class="p">)</span>
        <span class="nx">cohere</span><span class="p">(</span><span class="nx">goid</span><span class="p">,</span> <span class="nx">neighbours</span><span class="p">)</span>

		<span class="nx">stayInWindow</span><span class="p">(</span><span class="nx">goid</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Flocking simulations have advanced considerably since 30 years ago, but for this simple simulation I used the 3 classic rules from boids. All 3 rules require the goid to know who its neighbours are so it makes sense to figure that out first.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// find the nearest neighbours
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="nx">nearestNeighbours</span><span class="p">(</span><span class="nx">goids</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">(</span><span class="nx">neighbours</span> <span class="p">[]</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">neighbours</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Goid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">goids</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">goid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">goids</span> <span class="p">{</span>
		<span class="nx">neighbours</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">,</span> <span class="o">*</span><span class="nx">goid</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">sort</span><span class="p">.</span><span class="nx">SliceStable</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span>
	<span class="p">})</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// distance between 2 goids
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">n</span> <span class="nx">Goid</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">X</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">X</span>
	<span class="nx">y</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">Y</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Y</span>
	<span class="k">return</span> <span class="nx">math</span><span class="p">.</span><span class="nx">Sqrt</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="o">*</span><span class="nx">y</span><span class="p">))</span>

<span class="p">}</span></code></pre></div>
<p>First, we clone the entire population of goids, then we use <code>sort.SliceStable</code> to sort the cloned array by distance from the goid in question. Finding the distance is just a matter of using the Pythagoras theorem.</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/pythagoras.png" alt="Pythagoras theorem" /></p>

<p>This gives us a list of neighbouring goids, sorted by distances away. Let&rsquo;s look at the first rule.</p>

<h3 id="separation-rule">Separation rule</h3>

<p>This is the <em>personal space</em> rule. Let&rsquo;s say you&rsquo;re in a train with a number of other commuters, and it stops at a station where there are a number of people getting in. As they come in, they will fill up the space, and there will be some who end up too close to you. What would you do? You&rsquo;re going to move a bit away from them but not too close to others, and finally settling down to a comfortable distance from everyone else. This is that rule.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// steer to avoid crowding local goids
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">separate</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">,</span> <span class="nx">neighbours</span> <span class="p">[]</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">neighbours</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">numNeighbours</span><span class="p">]</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">g</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">separationFactor</span> <span class="p">{</span>
			<span class="nx">x</span> <span class="o">+=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">X</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">X</span>
			<span class="nx">y</span> <span class="o">+=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">Y</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Y</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vx</span> <span class="p">=</span> <span class="nx">x</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vy</span> <span class="p">=</span> <span class="nx">y</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">X</span> <span class="o">+=</span> <span class="nx">x</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Y</span> <span class="o">+=</span> <span class="nx">y</span>
<span class="p">}</span></code></pre></div>
<p>We&rsquo;re only interested in a limited number of neighbouring goids, which is specified by the parameter <code>numNeighbours</code>. The neighbouring goids must also be within the parameter <code>separationFactor</code> (not all neighbouring goids are close enough for it to be uncomfortable). Once these goids are in that space, we move a bit away from each one of them. Then we update the velocity to that distance away, and then move the goid by that velocity.</p>

<h3 id="alignment-rule">Alignment rule</h3>

<p>This is the <em>peer pressure</em> rule. Peer pressure is direct influence on people by their peers to change their behaviour to conform to their of the group. You might be familiar with peer pressure &ndash; when you see your neighbours with their shiny new 4K TV or iPhone X you might be tempted to get one for yourself as well. There are plenty of other examples of peer pressure in our lives that it doesn&rsquo;t need further explanation, and this is exactly what the alignment rule is.</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/lemmings.jpg" alt="lemmings" /></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// steer towards the average heading of local goids
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">align</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">,</span> <span class="nx">neighbours</span> <span class="p">[]</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">neighbours</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">numNeighbours</span><span class="p">]</span> <span class="p">{</span>
		<span class="nx">x</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Vx</span>
		<span class="nx">y</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Vy</span>
	<span class="p">}</span>
	<span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">:=</span> <span class="nx">x</span><span class="o">/</span><span class="nx">numNeighbours</span><span class="p">,</span> <span class="nx">y</span><span class="o">/</span><span class="nx">numNeighbours</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vx</span> <span class="o">+=</span> <span class="nx">dx</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vy</span> <span class="o">+=</span> <span class="nx">dy</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">X</span> <span class="o">+=</span> <span class="nx">dx</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Y</span> <span class="o">+=</span> <span class="nx">dy</span>
<span class="p">}</span></code></pre></div>
<p>As before, we are only interested in a limited number of neighbouring goids specified by <code>numNeighbours</code>. However instead of affecting the position of the goid, this rule changes the velocity of the goid and we add up the velocity of all the neighbouring goids, and divide it by the number of neighbours. The final value modifies the velocity instead of replacing it altogether, while the position of the goid is modified by the new value.</p>

<h3 id="cohesion-rule">Cohesion rule</h3>

<p>This is the <em>phalanx</em> rule. The Greek phalanx was a rectangular, close-rank infantry formation that marched and fought as one entity. It was one of the most effective and enduring military formation in ancient warfare. Its effectiveness lie in the tight formation of impenetrable shields and spears that slowly advanced forward, breaking through enemy ranks. The Romans later took the same idea to create the three-line Roman legion that was used to conquer the known world.</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/phalanx.jpg" alt="phalanx" /></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// steer to move toward the average position of local goids
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">cohere</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">,</span> <span class="nx">neighbours</span> <span class="p">[]</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">neighbours</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">numNeighbours</span><span class="p">]</span> <span class="p">{</span>
		<span class="nx">x</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">X</span>
		<span class="nx">y</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Y</span>
	<span class="p">}</span>
	<span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">:=</span> <span class="p">((</span><span class="nx">x</span><span class="o">/</span><span class="nx">numNeighbours</span><span class="p">)</span><span class="o">-</span><span class="nx">g</span><span class="p">.</span><span class="nx">X</span><span class="p">)</span><span class="o">/</span><span class="nx">coherenceFactor</span><span class="p">,</span> <span class="p">((</span><span class="nx">y</span><span class="o">/</span><span class="nx">numNeighbours</span><span class="p">)</span><span class="o">-</span><span class="nx">g</span><span class="p">.</span><span class="nx">Y</span><span class="p">)</span><span class="o">/</span><span class="nx">coherenceFactor</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vx</span> <span class="o">+=</span> <span class="nx">dx</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Vy</span> <span class="o">+=</span> <span class="nx">dy</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">X</span> <span class="o">+=</span> <span class="nx">dx</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">Y</span> <span class="o">+=</span> <span class="nx">dy</span>
<span class="p">}</span></code></pre></div>
<p>As with the other rules, we are only interested in the neighbouring goids. We take the average position of all these neighbours (adding up the positions of all the neighbours and dividing it by the number of neighbours), and subtract the goid&rsquo;s position from it. This value is then divided by a <code>coherenceFactor</code> that determines how much the goids want to cohere with its neighbours. If the <code>coherenceFactor</code> is too high, the goids will end up not moving, if it&rsquo;s too low it will end up sticking too closely with each other, forming clusters of tightly-knit goids.</p>

<h3 id="staying-within-view">Staying within view</h3>

<p>Now that we have the rules we can run simulation, but since our view is limited to the parameters <code>windowWidth</code> and <code>windowHeight</code>, once the goids wander off the screen we can&rsquo;t see it anymore. Which means after a while, it&rsquo;s just an empty screen. To stop that from happening, if a goid wanders off the screen, we magically transport it to the other side of the window.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// if goid goes out of the window frame it comes back on the other side
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">stayInWindow</span><span class="p">(</span><span class="nx">goid</span> <span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">X</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">goid</span><span class="p">.</span><span class="nx">X</span> <span class="p">=</span> <span class="nx">windowWidth</span> <span class="o">+</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">X</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">X</span> <span class="p">&gt;</span> <span class="nx">windowWidth</span> <span class="p">{</span>
		<span class="nx">goid</span><span class="p">.</span><span class="nx">X</span> <span class="p">=</span> <span class="nx">windowWidth</span> <span class="o">-</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">X</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span> <span class="p">=</span> <span class="nx">windowHeight</span> <span class="o">+</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span> <span class="p">&gt;</span> <span class="nx">windowHeight</span> <span class="p">{</span>
		<span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span> <span class="p">=</span> <span class="nx">windowHeight</span> <span class="o">-</span> <span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="showing-the-frame">Showing the frame</h3>

<p>The final piece of the puzzle is drawing the goids themselves.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// draw the goids
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">draw</span><span class="p">(</span><span class="nx">goids</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Goid</span><span class="p">)</span> <span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span> <span class="p">{</span>
	<span class="nx">dest</span> <span class="o">:=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">NewRGBA</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">windowWidth</span><span class="p">,</span> <span class="nx">windowHeight</span><span class="p">))</span>
	<span class="nx">gc</span> <span class="o">:=</span> <span class="nx">draw2dimg</span><span class="p">.</span><span class="nx">NewGraphicContext</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">goid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">goids</span> <span class="p">{</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">SetFillColor</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Color</span><span class="p">)</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">MoveTo</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">X</span><span class="p">),</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span><span class="p">))</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">ArcTo</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">X</span><span class="p">),</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span><span class="p">),</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">R</span><span class="p">),</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">R</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">math</span><span class="p">.</span><span class="nx">Pi</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">LineTo</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">X</span><span class="o">-</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Vx</span><span class="p">),</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Y</span><span class="o">-</span><span class="nx">goid</span><span class="p">.</span><span class="nx">Vy</span><span class="p">))</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
		<span class="nx">gc</span><span class="p">.</span><span class="nx">Fill</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">dest</span>
<span class="p">}</span></code></pre></div>
<p>Each frame is an image of width <code>windowWidth</code> and height <code>windowHeight</code>. WIthin this frame, we draw each goid as a circle, and then we draw a line to represent the goid&rsquo;s tail. This line goes against the direction of where the goid is going, so we subtract the position of the goid from its velocity.</p>

<h3 id="displaying-the-simulation">Displaying the simulation</h3>

<p>We have all the functions needed now, so let&rsquo;s put it all together in the <code>main</code> function.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">clearScreen</span><span class="p">()</span>
	<span class="nx">hideCursor</span><span class="p">()</span>

	<span class="nx">goids</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Goid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">populationSize</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">g</span> <span class="o">:=</span> <span class="nx">createRandomGoid</span><span class="p">()</span>
		<span class="nx">goids</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">goids</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">g</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">loops</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">move</span><span class="p">(</span><span class="nx">goids</span><span class="p">)</span>
		<span class="nx">frame</span> <span class="o">:=</span> <span class="nx">draw</span><span class="p">(</span><span class="nx">goids</span><span class="p">)</span>
		<span class="nx">printImage</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">SubImage</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">Rect</span><span class="p">))</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;\nLoop: %d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>

	<span class="p">}</span>
	<span class="nx">showCursor</span><span class="p">()</span>
<span class="p">}</span></code></pre></div>
<p>There are a few more functions that you&rsquo;re not seen before. What are <code>clearScreen</code>, <code>hideCursor</code>, <code>showCursor</code> and <code>printImage</code>? These are the functions that actually display the simulation.</p>

<p>Let&rsquo;s look at <code>clearScreen</code>, <code>hideCursor</code> and <code>showCursor</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">hideCursor</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;\x1b[?25l&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">showCursor</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;\x1b[?25h\n&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">clearScreen</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;\x1b[2J&#34;</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>So what&rsquo;s the strange escape sequences we used? These are <a href="https://en.wikipedia.org/wiki/ANSI_escape_code" target="_blank">ANSI escape sequences</a> used to control the various options on text terminals. They are mostly a relic of the past but still widely implemented in terminal emulators such as iTerm2. All sequences start with <code>ESC</code> (27 or in hex 0x1B), followed by a second byte that provides the control option. In particular, <code>ESC</code> followed by <code>[</code> indicates that the next byte is a Control Sequence Introducer (CSI), which is a set of useful sequences. For example, <code>?25h</code> shows the cursor and <code>?25l</code> hides the cursor. And as you would have probably guessed, <code>2J</code> clears the entire screen and moves the cursor to the upper left of the screen.</p>

<p>Let&rsquo;s look at how we print the image to the screen.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// this only works for iTerm!
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">printImage</span><span class="p">(</span><span class="nx">img</span> <span class="nx">image</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">buf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">png</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">img</span><span class="p">)</span>
	<span class="nx">imgBase64Str</span> <span class="o">:=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">StdEncoding</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;\x1b[2;0H\x1b]1337;File=inline=1:%s\a&#34;</span><span class="p">,</span> <span class="nx">imgBase64Str</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>This is an interesting hack that is only found (as far as I know) in <a href="https://www.iterm2.com/documentation-images.html" target="_blank">iTerm2</a>. that allows you to take the base64 representation of a binary image and prints it inline on the terminal. The escape sequence <code>2;0H</code> at the start of the line is a CSI that moves the cursor to row 2, column 0, where we want to print the image.</p>

<h2 id="final-simulation">Final simulation</h2>

<p>This is how it looks when I run it.</p>

<p><img src="https://github.com/sausheong/goids/raw/master/imgs/goids.gif" alt="Goids" /></p>

<h2 id="code">Code</h2>

<p>All the code found here can get found at <a href="http://github.com/sausheong/goids" target="_blank">http://github.com/sausheong/goids</a>.</p>

<h2 id="why-did-i-do-this">Why did I do this?</h2>

<p>Flocking simulations have been done to the death, but I enjoy writing it. I guess that&rsquo;s probably why I did it for the I-don&rsquo;t-know-how-many-times. Also, it gives me ideas and practice on where else to take it, and also doing more with the idea of printing frames on a terminal. You&rsquo;ll probably see more of this later.</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'space';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/sausheong">Chang Sau Sheong</a> 2018</p>
    
  </div>
</section>

</body>
</html>
